# Generated by Django 4.2.16 on 2025-11-25 10:28

from django.conf import settings
import django.core.validators
from django.db import migrations, models
import django.db.models.deletion
import uuid


class Migration(migrations.Migration):

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('auth_module', '0002_mfapolicy_continuousauthsession_adaptivemfalog_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='PasskeyRecoverySetup',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('is_active', models.BooleanField(default=False)),
                ('total_shards', models.IntegerField(default=5, validators=[django.core.validators.MinValueValidator(3), django.core.validators.MaxValueValidator(10)])),
                ('threshold_shards', models.IntegerField(default=3, validators=[django.core.validators.MinValueValidator(2)])),
                ('encryption_algorithm', models.CharField(default='CRYSTALS-Kyber-768', max_length=50)),
                ('kyber_public_key', models.BinaryField(help_text='Post-quantum public key')),
                ('kyber_private_key_encrypted', models.BinaryField(help_text='Encrypted private key')),
                ('max_recovery_attempts_per_month', models.IntegerField(default=3)),
                ('recovery_cooldown_days', models.IntegerField(default=7)),
                ('decay_window_days', models.IntegerField(default=14, help_text='Recovery request auto-expires after this period')),
                ('canary_alert_window_hours', models.IntegerField(default=48, help_text='Time window for user to cancel recovery')),
                ('challenge_distribution_days', models.IntegerField(default=3)),
                ('minimum_challenge_success_rate', models.FloatField(default=0.8, validators=[django.core.validators.MinValueValidator(0.5), django.core.validators.MaxValueValidator(1.0)])),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('last_rehearsal_at', models.DateTimeField(blank=True, null=True)),
                ('travel_lock_enabled', models.BooleanField(default=False)),
                ('travel_lock_until', models.DateTimeField(blank=True, null=True)),
                ('user', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='passkey_recovery_setup', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Passkey Recovery Setup',
                'verbose_name_plural': 'Passkey Recovery Setups',
            },
        ),
        migrations.CreateModel(
            name='RecoveryAttempt',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('status', models.CharField(choices=[('initiated', 'Initiated'), ('challenge_phase', 'Challenge Phase'), ('shard_collection', 'Shard Collection'), ('guardian_approval', 'Guardian Approval Pending'), ('final_verification', 'Final Verification'), ('completed', 'Completed'), ('failed', 'Failed'), ('cancelled', 'Cancelled by User'), ('expired', 'Expired')], default='initiated', max_length=30)),
                ('initiated_from_ip', models.GenericIPAddressField()),
                ('initiated_from_device_fingerprint', models.CharField(blank=True, max_length=255)),
                ('initiated_from_location', models.JSONField(blank=True, default=dict)),
                ('challenges_sent', models.IntegerField(default=0)),
                ('challenges_completed', models.IntegerField(default=0)),
                ('challenges_failed', models.IntegerField(default=0)),
                ('trust_score', models.FloatField(default=0.0, validators=[django.core.validators.MinValueValidator(0.0), django.core.validators.MaxValueValidator(1.0)])),
                ('shards_collected', models.JSONField(default=list, help_text='List of collected shard IDs')),
                ('shards_required', models.IntegerField()),
                ('guardian_approvals_received', models.JSONField(default=list, help_text='List of guardian IDs who approved')),
                ('guardian_approvals_required', models.IntegerField()),
                ('honeypot_triggered', models.BooleanField(default=False)),
                ('suspicious_activity_detected', models.BooleanField(default=False)),
                ('suspicious_activity_details', models.JSONField(blank=True, default=dict)),
                ('canary_alert_sent_at', models.DateTimeField(blank=True, null=True)),
                ('canary_alert_acknowledged', models.BooleanField(default=False)),
                ('user_cancelled', models.BooleanField(default=False)),
                ('initiated_at', models.DateTimeField(auto_now_add=True)),
                ('expires_at', models.DateTimeField()),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('recovery_successful', models.BooleanField(default=False)),
                ('failure_reason', models.TextField(blank=True)),
                ('recovery_setup', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='recovery_attempts', to='auth_module.passkeyrecoverysetup')),
            ],
            options={
                'verbose_name': 'Recovery Attempt',
                'verbose_name_plural': 'Recovery Attempts',
                'ordering': ['-initiated_at'],
            },
        ),
        migrations.CreateModel(
            name='RecoveryShard',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('shard_type', models.CharField(choices=[('guardian', 'Guardian Shard'), ('device', 'Device Shard'), ('biometric', 'Biometric Shard'), ('behavioral', 'Behavioral Shard'), ('temporal', 'Temporal Shard'), ('honeypot', 'Honeypot Shard (Decoy)')], max_length=20)),
                ('shard_index', models.IntegerField()),
                ('encrypted_shard_data', models.BinaryField()),
                ('encryption_metadata', models.JSONField(default=dict)),
                ('context_data', models.JSONField(default=dict, help_text='Type-specific context (guardian ID, device fingerprint, etc)')),
                ('is_active', models.BooleanField(default=True)),
                ('is_honeypot', models.BooleanField(default=False, help_text='Decoy shard that triggers alerts')),
                ('last_accessed_at', models.DateTimeField(blank=True, null=True)),
                ('access_count', models.IntegerField(default=0)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('recovery_setup', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='shards', to='auth_module.passkeyrecoverysetup')),
            ],
            options={
                'verbose_name': 'Recovery Shard',
                'verbose_name_plural': 'Recovery Shards',
            },
        ),
        migrations.CreateModel(
            name='RecoveryGuardian',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('encrypted_guardian_info', models.BinaryField(help_text='Encrypted email/phone/identity')),
                ('guardian_public_key', models.BinaryField(help_text="Guardian's public key for shard encryption")),
                ('status', models.CharField(choices=[('pending', 'Invitation Pending'), ('active', 'Active'), ('declined', 'Declined'), ('revoked', 'Revoked')], default='pending', max_length=20)),
                ('requires_video_verification', models.BooleanField(default=False)),
                ('requires_in_person_verification', models.BooleanField(default=False)),
                ('custom_security_requirements', models.JSONField(default=dict)),
                ('invitation_token', models.CharField(max_length=255, unique=True)),
                ('invitation_sent_at', models.DateTimeField(auto_now_add=True)),
                ('invitation_expires_at', models.DateTimeField()),
                ('accepted_at', models.DateTimeField(blank=True, null=True)),
                ('last_approval_given_at', models.DateTimeField(blank=True, null=True)),
                ('total_approvals_given', models.IntegerField(default=0)),
                ('approval_window_start', models.DateTimeField(blank=True, null=True)),
                ('approval_window_end', models.DateTimeField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('recovery_setup', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='guardians', to='auth_module.passkeyrecoverysetup')),
                ('shard', models.OneToOneField(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='guardian_holder', to='auth_module.recoveryshard')),
            ],
            options={
                'verbose_name': 'Recovery Guardian',
                'verbose_name_plural': 'Recovery Guardians',
            },
        ),
        migrations.CreateModel(
            name='RecoveryAuditLog',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('event_type', models.CharField(choices=[('setup_created', 'Recovery Setup Created'), ('setup_updated', 'Recovery Setup Updated'), ('guardian_invited', 'Guardian Invited'), ('guardian_accepted', 'Guardian Accepted Invitation'), ('guardian_declined', 'Guardian Declined Invitation'), ('guardian_revoked', 'Guardian Revoked'), ('shard_created', 'Shard Created'), ('shard_accessed', 'Shard Accessed'), ('honeypot_triggered', 'Honeypot Shard Triggered'), ('recovery_initiated', 'Recovery Initiated'), ('challenge_sent', 'Challenge Sent'), ('challenge_completed', 'Challenge Completed'), ('challenge_failed', 'Challenge Failed'), ('guardian_approval_requested', 'Guardian Approval Requested'), ('guardian_approved', 'Guardian Approved'), ('guardian_denied', 'Guardian Denied'), ('canary_alert_sent', 'Canary Alert Sent'), ('user_cancelled_recovery', 'User Cancelled Recovery'), ('recovery_completed', 'Recovery Completed'), ('recovery_failed', 'Recovery Failed'), ('suspicious_activity', 'Suspicious Activity Detected'), ('travel_lock_enabled', 'Travel Lock Enabled'), ('travel_lock_disabled', 'Travel Lock Disabled'), ('rehearsal_conducted', 'Recovery Rehearsal Conducted')], max_length=50)),
                ('event_data', models.JSONField(default=dict, help_text='Additional event details')),
                ('recovery_attempt_id', models.UUIDField(blank=True, null=True)),
                ('ip_address', models.GenericIPAddressField(blank=True, null=True)),
                ('user_agent', models.TextField(blank=True)),
                ('device_fingerprint', models.CharField(blank=True, max_length=255)),
                ('geolocation', models.JSONField(blank=True, default=dict)),
                ('timestamp', models.DateTimeField(auto_now_add=True)),
                ('cryptographic_hash', models.CharField(help_text='SHA-256 hash of previous log entry', max_length=64)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='recovery_audit_logs', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Recovery Audit Log',
                'verbose_name_plural': 'Recovery Audit Logs',
                'ordering': ['-timestamp'],
            },
        ),
        migrations.CreateModel(
            name='GuardianApproval',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('approved', 'Approved'), ('denied', 'Denied'), ('expired', 'Expired')], default='pending', max_length=20)),
                ('approval_token', models.CharField(max_length=255, unique=True)),
                ('requested_at', models.DateTimeField(auto_now_add=True)),
                ('approval_window_start', models.DateTimeField()),
                ('approval_window_end', models.DateTimeField()),
                ('responded_at', models.DateTimeField(blank=True, null=True)),
                ('response_ip', models.GenericIPAddressField(blank=True, null=True)),
                ('response_device_fingerprint', models.CharField(blank=True, max_length=255)),
                ('video_verification_completed', models.BooleanField(default=False)),
                ('video_verification_session_id', models.CharField(blank=True, max_length=255)),
                ('in_person_verification_completed', models.BooleanField(default=False)),
                ('shard_released', models.BooleanField(default=False)),
                ('shard_released_at', models.DateTimeField(blank=True, null=True)),
                ('guardian', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='approvals_given', to='auth_module.recoveryguardian')),
                ('recovery_attempt', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='guardian_approvals', to='auth_module.recoveryattempt')),
            ],
            options={
                'verbose_name': 'Guardian Approval',
                'verbose_name_plural': 'Guardian Approvals',
            },
        ),
        migrations.CreateModel(
            name='BehavioralBiometrics',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('avg_typing_speed_wpm', models.FloatField(blank=True, null=True)),
                ('keystroke_dynamics', models.JSONField(default=dict, help_text='Timing patterns between keystrokes')),
                ('mouse_movement_patterns', models.JSONField(default=dict)),
                ('touch_pressure_patterns', models.JSONField(blank=True, default=dict)),
                ('typical_login_times', models.JSONField(default=list, help_text='List of typical login hours')),
                ('typical_locations', models.JSONField(default=list, help_text='List of typical geolocations')),
                ('typical_devices', models.JSONField(default=list, help_text='List of device fingerprints')),
                ('avg_session_duration_minutes', models.FloatField(blank=True, null=True)),
                ('typical_actions_sequence', models.JSONField(default=list, help_text='Common action sequences')),
                ('last_updated', models.DateTimeField(auto_now=True)),
                ('samples_collected', models.IntegerField(default=0, help_text='Number of behavioral samples')),
                ('user', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='behavioral_biometrics', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Behavioral Biometrics',
                'verbose_name_plural': 'Behavioral Biometrics',
            },
        ),
        migrations.CreateModel(
            name='TemporalChallenge',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('challenge_type', models.CharField(choices=[('historical_activity', 'Historical Account Activity'), ('device_fingerprint', 'Device Fingerprint Recognition'), ('geolocation_pattern', 'Geolocation Pattern Matching'), ('usage_time_window', 'Typical Usage Time Window'), ('vault_content_knowledge', 'Vault Content Knowledge'), ('behavioral_biometric', 'Behavioral Biometric')], max_length=30)),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('sent', 'Sent'), ('completed', 'Completed'), ('failed', 'Failed'), ('expired', 'Expired')], default='pending', max_length=20)),
                ('encrypted_challenge_data', models.BinaryField()),
                ('encrypted_expected_response', models.BinaryField(help_text='Encrypted correct answer')),
                ('delivery_channel', models.CharField(help_text='email, sms, app_notification', max_length=50)),
                ('sent_to', models.CharField(help_text='Encrypted recipient', max_length=255)),
                ('sent_at', models.DateTimeField(blank=True, null=True)),
                ('user_response', models.TextField(blank=True)),
                ('response_received_at', models.DateTimeField(blank=True, null=True)),
                ('response_correct', models.BooleanField(default=False)),
                ('response_location', models.JSONField(blank=True, default=dict)),
                ('response_device_fingerprint', models.CharField(blank=True, max_length=255)),
                ('expected_response_time_window_start', models.DateTimeField()),
                ('expected_response_time_window_end', models.DateTimeField()),
                ('actual_response_time_seconds', models.IntegerField(blank=True, null=True)),
                ('timing_pattern_matches', models.BooleanField(default=False)),
                ('expires_at', models.DateTimeField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('recovery_attempt', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='challenges', to='auth_module.recoveryattempt')),
            ],
            options={
                'verbose_name': 'Temporal Challenge',
                'verbose_name_plural': 'Temporal Challenges',
                'ordering': ['created_at'],
                'indexes': [models.Index(fields=['recovery_attempt', 'status'], name='auth_module_recover_8f7802_idx'), models.Index(fields=['sent_at', 'status'], name='auth_module_sent_at_2596a6_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='recoveryshard',
            index=models.Index(fields=['recovery_setup', 'shard_type', 'is_active'], name='auth_module_recover_a9891b_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='recoveryshard',
            unique_together={('recovery_setup', 'shard_index')},
        ),
        migrations.AddIndex(
            model_name='recoveryguardian',
            index=models.Index(fields=['recovery_setup', 'status'], name='auth_module_recover_2bed79_idx'),
        ),
        migrations.AddIndex(
            model_name='recoveryguardian',
            index=models.Index(fields=['invitation_token'], name='auth_module_invitat_604251_idx'),
        ),
        migrations.AddIndex(
            model_name='recoveryauditlog',
            index=models.Index(fields=['user', 'event_type', 'timestamp'], name='auth_module_user_id_910e26_idx'),
        ),
        migrations.AddIndex(
            model_name='recoveryauditlog',
            index=models.Index(fields=['recovery_attempt_id', 'timestamp'], name='auth_module_recover_64f1a2_idx'),
        ),
        migrations.AddIndex(
            model_name='recoveryattempt',
            index=models.Index(fields=['recovery_setup', 'status'], name='auth_module_recover_97e37d_idx'),
        ),
        migrations.AddIndex(
            model_name='recoveryattempt',
            index=models.Index(fields=['initiated_at', 'status'], name='auth_module_initiat_2cd8a9_idx'),
        ),
        migrations.AddIndex(
            model_name='passkeyrecoverysetup',
            index=models.Index(fields=['user', 'is_active'], name='auth_module_user_id_9c873b_idx'),
        ),
        migrations.AddIndex(
            model_name='guardianapproval',
            index=models.Index(fields=['recovery_attempt', 'status'], name='auth_module_recover_6e137c_idx'),
        ),
        migrations.AddIndex(
            model_name='guardianapproval',
            index=models.Index(fields=['approval_token'], name='auth_module_approva_ab6b47_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='guardianapproval',
            unique_together={('recovery_attempt', 'guardian')},
        ),
    ]
