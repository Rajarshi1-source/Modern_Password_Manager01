# Generated by Django 4.2.16 on 2025-11-19 14:21

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('auth_module', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='MFAPolicy',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('low_risk_factors', models.IntegerField(default=1, help_text='Factors required for low risk')),
                ('medium_risk_factors', models.IntegerField(default=2, help_text='Factors required for medium risk')),
                ('high_risk_factors', models.IntegerField(default=3, help_text='Factors required for high risk')),
                ('critical_risk_factors', models.IntegerField(default=3, help_text='Factors required for critical risk + admin approval')),
                ('allow_password', models.BooleanField(default=True)),
                ('allow_totp', models.BooleanField(default=True)),
                ('allow_sms', models.BooleanField(default=True)),
                ('allow_email', models.BooleanField(default=True)),
                ('allow_passkey', models.BooleanField(default=True)),
                ('allow_biometric_face', models.BooleanField(default=True)),
                ('allow_biometric_voice', models.BooleanField(default=True)),
                ('allow_push_notification', models.BooleanField(default=True)),
                ('enable_adaptive_mfa', models.BooleanField(default=True, help_text='Automatically adjust factors based on risk')),
                ('enable_continuous_auth', models.BooleanField(default=False, help_text='Enable continuous authentication')),
                ('enable_geofencing', models.BooleanField(default=False)),
                ('allowed_countries', models.JSONField(blank=True, default=list, help_text='List of allowed country codes')),
                ('trusted_locations', models.JSONField(blank=True, default=list, help_text='List of trusted lat/lon coordinates')),
                ('enable_time_restrictions', models.BooleanField(default=False)),
                ('allowed_hours', models.JSONField(blank=True, default=dict, help_text='Allowed hours by day of week')),
                ('fallback_to_email', models.BooleanField(default=True, help_text='Allow email as fallback')),
                ('fallback_to_recovery_codes', models.BooleanField(default=True)),
                ('max_session_duration_minutes', models.IntegerField(default=60)),
                ('require_reauth_for_sensitive_ops', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('user', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='mfa_policy', to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='ContinuousAuthSession',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('session_id', models.CharField(max_length=255, unique=True)),
                ('status', models.CharField(choices=[('active', 'Active'), ('challenged', 'Challenged'), ('terminated', 'Terminated'), ('expired', 'Expired')], default='active', max_length=20)),
                ('initial_auth_score', models.FloatField(default=1.0)),
                ('current_auth_score', models.FloatField(default=1.0)),
                ('min_auth_threshold', models.FloatField(default=0.6)),
                ('face_checks_count', models.IntegerField(default=0)),
                ('voice_checks_count', models.IntegerField(default=0)),
                ('behavioral_checks_count', models.IntegerField(default=0)),
                ('device_fingerprint', models.CharField(max_length=255)),
                ('ip_address', models.GenericIPAddressField()),
                ('user_agent', models.TextField()),
                ('started_at', models.DateTimeField(auto_now_add=True)),
                ('last_check_at', models.DateTimeField(auto_now=True)),
                ('challenged_at', models.DateTimeField(blank=True, null=True)),
                ('terminated_at', models.DateTimeField(blank=True, null=True)),
                ('expires_at', models.DateTimeField()),
                ('challenge_reason', models.TextField(blank=True)),
                ('challenge_passed', models.BooleanField(default=False)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='continuous_auth_sessions', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-started_at'],
            },
        ),
        migrations.CreateModel(
            name='AdaptiveMFALog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('calculated_risk_level', models.CharField(max_length=20)),
                ('risk_factors', models.JSONField(default=list, help_text='Factors contributing to risk')),
                ('ml_risk_score', models.FloatField(help_text='ML-computed risk score')),
                ('factors_required', models.IntegerField()),
                ('factors_available', models.JSONField(default=list)),
                ('factors_selected', models.JSONField(default=list)),
                ('trigger_action', models.CharField(help_text='Action that triggered MFA', max_length=100)),
                ('ip_address', models.GenericIPAddressField()),
                ('device_fingerprint', models.CharField(blank=True, max_length=255)),
                ('location', models.JSONField(blank=True, default=dict)),
                ('auth_successful', models.BooleanField(default=False)),
                ('time_to_complete_seconds', models.IntegerField(default=0)),
                ('timestamp', models.DateTimeField(auto_now_add=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='adaptive_mfa_logs', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-timestamp'],
            },
        ),
        migrations.CreateModel(
            name='MFAFactor',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('factor_type', models.CharField(choices=[('password', 'Password'), ('totp', 'TOTP (Authenticator App)'), ('sms', 'SMS'), ('email', 'Email'), ('passkey', 'Passkey/WebAuthn'), ('face', 'Face Recognition'), ('voice', 'Voice Recognition'), ('fingerprint', 'Fingerprint'), ('push', 'Push Notification'), ('backup_code', 'Backup Code')], max_length=20)),
                ('status', models.CharField(choices=[('active', 'Active'), ('pending', 'Pending Setup'), ('suspended', 'Suspended'), ('revoked', 'Revoked')], default='pending', max_length=20)),
                ('factor_data', models.JSONField(default=dict, help_text='Encrypted factor-specific data')),
                ('device_info', models.JSONField(default=dict, help_text='Device information')),
                ('trust_score', models.FloatField(default=1.0, help_text='Factor reliability score (0-1)')),
                ('is_primary', models.BooleanField(default=False, help_text='Primary authentication factor')),
                ('last_used_at', models.DateTimeField(blank=True, null=True)),
                ('success_count', models.IntegerField(default=0)),
                ('failure_count', models.IntegerField(default=0)),
                ('registered_at', models.DateTimeField(auto_now_add=True)),
                ('activated_at', models.DateTimeField(blank=True, null=True)),
                ('suspended_at', models.DateTimeField(blank=True, null=True)),
                ('revoked_at', models.DateTimeField(blank=True, null=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='mfa_factors', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-is_primary', '-registered_at'],
                'unique_together': {('user', 'factor_type', 'device_info')},
            },
        ),
        migrations.CreateModel(
            name='BiometricProfile',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('biometric_type', models.CharField(choices=[('face', 'Face Recognition'), ('voice', 'Voice Recognition'), ('fingerprint', 'Fingerprint'), ('iris', 'Iris Scan')], max_length=20)),
                ('embedding_data', models.TextField(help_text='Encrypted biometric embedding')),
                ('embedding_hash', models.CharField(help_text='SHA-256 hash of embedding for lookup', max_length=64, unique=True)),
                ('device_id', models.CharField(blank=True, help_text='Device used for registration', max_length=255)),
                ('is_active', models.BooleanField(default=True)),
                ('confidence_threshold', models.FloatField(default=0.7, help_text='Minimum confidence for authentication')),
                ('requires_liveness', models.BooleanField(default=True)),
                ('liveness_score', models.FloatField(blank=True, help_text='Last liveness detection score', null=True)),
                ('registered_at', models.DateTimeField(auto_now_add=True)),
                ('last_used_at', models.DateTimeField(blank=True, null=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('expires_at', models.DateTimeField(blank=True, help_text='Biometric expiration date', null=True)),
                ('success_count', models.IntegerField(default=0)),
                ('failure_count', models.IntegerField(default=0)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='biometric_profiles', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-registered_at'],
                'unique_together': {('user', 'biometric_type', 'device_id')},
            },
        ),
        migrations.CreateModel(
            name='AuthenticationAttempt',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('username', models.CharField(help_text='Attempted username', max_length=150)),
                ('factors_used', models.JSONField(default=list, help_text='List of factors used')),
                ('factors_required', models.IntegerField(default=1, help_text='Number of factors required')),
                ('factors_completed', models.IntegerField(default=0, help_text='Number of factors successfully completed')),
                ('result', models.CharField(choices=[('success', 'Success'), ('failure', 'Failure'), ('partial', 'Partial Success'), ('blocked', 'Blocked')], max_length=20)),
                ('failure_reason', models.TextField(blank=True)),
                ('risk_level', models.CharField(default='low', max_length=20)),
                ('risk_score', models.FloatField(default=0.0, help_text='ML-computed risk score (0-1)')),
                ('anomaly_detected', models.BooleanField(default=False)),
                ('anomaly_details', models.JSONField(blank=True, default=dict)),
                ('ip_address', models.GenericIPAddressField()),
                ('user_agent', models.TextField()),
                ('device_fingerprint', models.CharField(blank=True, max_length=255)),
                ('location_data', models.JSONField(blank=True, default=dict)),
                ('attempt_timestamp', models.DateTimeField(auto_now_add=True)),
                ('duration_ms', models.IntegerField(default=0, help_text='Authentication duration in milliseconds')),
                ('blocked_until', models.DateTimeField(blank=True, help_text='Account locked until', null=True)),
                ('notification_sent', models.BooleanField(default=False)),
                ('admin_notified', models.BooleanField(default=False)),
                ('user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='auth_attempts', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-attempt_timestamp'],
                'indexes': [models.Index(fields=['user', '-attempt_timestamp'], name='auth_module_user_id_ed5c8d_idx'), models.Index(fields=['ip_address', '-attempt_timestamp'], name='auth_module_ip_addr_759b2d_idx'), models.Index(fields=['result', '-attempt_timestamp'], name='auth_module_result_5c20b5_idx')],
            },
        ),
    ]
